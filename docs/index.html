<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kyotei AI Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        :root { --primary: #0055aa; --rough: #d63031; --solid: #00b894; --bg: #f5f6fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 18px; text-align: center; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .race-card { background: white; border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .race-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .stadium-name { font-weight: bold; font-size: 1.1em; }
        .race-num { background: #333; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }
        
        .logic-badge { padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.8em; margin-left: 8px; }
        .logic-SOLID { background: var(--solid); }
        .logic-ROUGH { background: var(--rough); }
        
        .bet-box { font-family: monospace; font-size: 1.2em; font-weight: bold; margin: 5px 0; display: flex; align-items: center; }
        .icon { margin-right: 8px; }

        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        
        .error-box { background: #ffecec; color: #d63031; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; line-height: 1.6; }
        code { background: #eee; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <header><h1>ç«¶è‰‡AIäºˆæƒ³ Pro</h1></header>
    
    <div class="container" id="app">
        <div style="text-align:center; padding: 40px; color: #999;">
            ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
        </div>
    </div>

    <button class="fab" onclick="fetchData()">â†»</button>

    <script>
        async function fetchData() {
            const app = document.getElementById('app');
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œãƒã‚§ãƒƒã‚¯
            if (window.location.protocol === 'file:') {
                app.innerHTML = `
                    <div class="error-box">
                        <strong>âš ï¸ å®Ÿè¡Œç’°å¢ƒã‚¨ãƒ©ãƒ¼</strong><br>
                        HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã¾ã™ã€‚<br>
                        ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚<br><br>
                        VS Codeã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã€<br>
                        <code>python -m http.server</code><br>
                        è¡¨ç¤ºã•ã‚Œã‚‹URL (localhost:8000) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
                    </div>`;
                return;
            }

            try {
                const ts = new Date().getTime();
                const res = await fetch(`data/latest_odds.json?t=${ts}`);
                
                if (!res.ok) {
                    throw new Error(`HTTP Status: ${res.status}`);
                }
                
                const data = await res.json();
                renderApp(data);
                
            } catch (e) {
                console.error(e);
                app.innerHTML = `
                    <div class="error-box">
                        <strong>ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</strong><br>
                        ${e.message}<br><br>
                        <small>
                        1. scraper.py ã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸã‹ï¼Ÿ<br>
                        2. docs/data/latest_odds.json ã¯å­˜åœ¨ã—ã¾ã™ã‹ï¼Ÿ
                        </small>
                    </div>`;
            }
        }

        function renderApp(data) {
            const app = document.getElementById('app');
            let html = '';
            const stadiumKeys = Object.keys(data).sort();

            if (stadiumKeys.length === 0) {
                app.innerHTML = '<div class="error-box">æœ¬æ—¥ã®é–‹å‚¬ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>Scraperã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            stadiumKeys.forEach(jcd => {
                const races = data[jcd];
                // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (races.length > 0) {
                    html += `<div style="margin-top:20px; font-weight:bold; color:#666;">å ´ã‚³ãƒ¼ãƒ‰: ${jcd}</div>`;
                }
                
                races.forEach(race => {
                    html += `
                    <div class="race-card">
                        <div class="race-header">
                            <div>
                                <span class="stadium-name">ãƒ¬ãƒ¼ã‚¹ ${race.race_no}R</span>
                                <span class="logic-badge logic-${race.prediction_logic}">${race.prediction_logic}</span>
                            </div>
                            <span class="race-num">AIæ¨å¥¨</span>
                        </div>
                        <div>
                            ${race.predictions.map((p, i) => 
                                `<div class="bet-box">
                                    <span class="icon">${i===0 ? 'ğŸ¯' : 'âš ï¸'}</span> ${p}
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                });
            });
            app.innerHTML = html || '<div style="text-align:center; padding:20px;">æœ‰åŠ¹ãªäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
        fetchData();
    </script>
</body>
</html>
