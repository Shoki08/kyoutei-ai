<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kyotei AI Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        :root { 
            --primary: #0055aa; 
            --rough: #d63031; 
            --solid: #00b894; 
            --skip: #b2bec3; /* SKIPç”¨ã®ã‚°ãƒ¬ãƒ¼ */
            --bg: #f5f6fa; 
            --text: #2d3436;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        header { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        h1 { margin: 0; font-size: 18px; text-align: center; font-weight: 700; letter-spacing: 0.5px; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .race-card { background: white; border-radius: 16px; margin-bottom: 20px; padding: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        
        .race-header { padding: 12px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .stadium-info { display: flex; align-items: center; gap: 10px; }
        .stadium-code { font-weight: 800; font-size: 16px; color: var(--text); }
        .race-no { font-size: 14px; color: #636e72; background: #dfe6e9; padding: 2px 8px; border-radius: 12px; font-weight: bold; }
        
        .logic-badge { padding: 4px 10px; border-radius: 6px; color: white; font-size: 11px; font-weight: bold; letter-spacing: 0.5px; text-transform: uppercase; }
        .logic-SOLID { background: var(--solid); box-shadow: 0 2px 5px rgba(0,184,148,0.3); }
        .logic-ROUGH { background: var(--rough); box-shadow: 0 2px 5px rgba(214,48,49,0.3); }
        .logic-SKIP { background: var(--skip); color: #636e72; box-shadow: none; }

        .prediction-area { padding: 15px 20px; }
        
        /* è²·ã„ç›®ã®è¡Œãƒ‡ã‚¶ã‚¤ãƒ³ */
        .bet-row { display: flex; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
        .bet-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        
        .bet-icon { font-size: 18px; margin-right: 12px; width: 24px; text-align: center; }
        .bet-numbers { font-family: 'Courier New', monospace; font-size: 20px; font-weight: 800; color: var(--text); letter-spacing: 1px; flex-grow: 1; }
        
        /* ã‚ªãƒƒã‚ºã®è¡¨ç¤ºãƒ‡ã‚¶ã‚¤ãƒ³ */
        .bet-odds { font-size: 13px; color: #fff; background: var(--primary); padding: 2px 8px; border-radius: 12px; font-weight: bold; }
        .bet-odds.low-odds { background: #b2bec3; } /* å®‰ã„ã‚ªãƒƒã‚º */
        .bet-odds.high-odds { background: var(--rough); } /* ç©´ã‚ªãƒƒã‚º */

        /* SKIPæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .skip-message { text-align: center; color: #b2bec3; font-weight: bold; padding: 10px; font-size: 14px; }

        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 28px; box-shadow: 0 4px 15px rgba(0,85,170,0.4); cursor: pointer; transition: transform 0.2s; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .fab:active { transform: scale(0.95); }
        
        .error-box { background: #fff0f0; color: #d63031; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px; font-size: 14px; line-height: 1.6; border: 1px solid #ffcccc; }
    </style>
</head>
<body>
    <header><h1>Kyotei AI Pro</h1></header>
    
    <div class="container" id="app">
        <div style="text-align:center; padding: 60px 20px; color: #b2bec3;">
            <div style="font-size: 40px; margin-bottom: 20px;">ğŸš¤</div>
            ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...
        </div>
    </div>

    <button class="fab" onclick="fetchData()">â†»</button>

    <script>
        async function fetchData() {
            const app = document.getElementById('app');
            
            // ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œãƒã‚§ãƒƒã‚¯
            if (window.location.protocol === 'file:') {
                app.innerHTML = `<div class="error-box">âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼<br>python -m http.server ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>`;
                return;
            }

            try {
                const ts = new Date().getTime();
                const res = await fetch(`data/latest_odds.json?t=${ts}`);
                if (!res.ok) throw new Error("ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—");
                const data = await res.json();
                renderApp(data);
            } catch (e) {
                console.error(e);
                app.innerHTML = `<div class="error-box"><strong>ãƒ‡ãƒ¼ã‚¿å¾…æ©Ÿä¸­</strong><br>æ¬¡å›æ›´æ–°(08:30)ã‚’ãŠå¾…ã¡ãã ã•ã„<br><span style="font-size:10px; opacity:0.7">${e.message}</span></div>`;
            }
        }

        function renderApp(data) {
            const app = document.getElementById('app');
            let html = '';
            const stadiumKeys = Object.keys(data).sort();

            if (stadiumKeys.length === 0) {
                app.innerHTML = '<div class="error-box">æœ¬æ—¥ã®é–‹å‚¬ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                return;
            }

            stadiumKeys.forEach(jcd => {
                const races = data[jcd];
                if (races.length === 0) return;

                // å ´ã”ã¨ã®åŒºåˆ‡ã‚Šï¼ˆä»»æ„ï¼‰
                // html += `<div style="margin: 20px 0 10px 10px; font-weight:bold; color:#636e72; font-size:12px;">å ´ã‚³ãƒ¼ãƒ‰: ${jcd}</div>`;
                
                races.forEach(race => {
                    const isSkip = race.prediction_logic === 'SKIP';
                    
                    html += `
                    <div class="race-card">
                        <div class="race-header">
                            <div class="stadium-info">
                                <span class="stadium-code">#${jcd}</span>
                                <span class="race-no">${race.race_no}R</span>
                            </div>
                            <span class="logic-badge logic-${race.prediction_logic}">${race.prediction_logic}</span>
                        </div>
                        <div class="prediction-area">
                            ${renderPredictions(race.predictions, isSkip)}
                        </div>
                    </div>`;
                });
            });
            app.innerHTML = html;
        }

        function renderPredictions(preds, isSkip) {
            if (isSkip) {
                // è¦‹é€ã‚Šã®å ´åˆã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‡ºã•ãšã‚·ãƒ³ãƒ—ãƒ«ã«
                return `<div class="skip-message">ğŸ›‘ ${preds[0]}</div>`;
            }

            return preds.map((p, i) => {
                // ã‚ªãƒƒã‚ºè§£æ "1-2-3 (15.2å€)" -> bet="1-2-3", odds="15.2"
                let bet = p;
                let oddsHtml = '';
                
                // æ­£è¦è¡¨ç¾ã§ã‚ªãƒƒã‚ºéƒ¨åˆ†ã‚’æŠ½å‡º
                const match = p.match(/(.+)\s\((.+å€)\)/);
                if (match) {
                    bet = match[1];
                    const oddsVal = parseFloat(match[2].replace('å€',''));
                    // ã‚ªãƒƒã‚ºã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
                    let oddsClass = 'bet-odds';
                    if (oddsVal < 5.0) oddsClass += ' low-odds'; // å®‰ã„
                    if (oddsVal > 20.0) oddsClass += ' high-odds'; // ç©´
                    
                    oddsHtml = `<span class="${oddsClass}">${match[2]}</span>`;
                } else if (p.includes("å®‰ã„ã‹ã‚‚")) {
                     oddsHtml = `<span class="bet-odds low-odds">æ³¨æ„</span>`;
                }

                // ã‚¢ã‚¤ã‚³ãƒ³æ±ºå®š
                let icon = 'âš ï¸';
                if (i === 0) icon = 'ğŸ¯'; // æœ¬å‘½
                if (i === 1) icon = 'ğŸ¥ˆ'; // å¯¾æŠ—
                
                return `
                <div class="bet-row">
                    <span class="bet-icon">${icon}</span>
                    <span class="bet-numbers">${bet}</span>
                    ${oddsHtml}
                </div>`;
            }).join('');
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
        fetchData();
    </script>
</body>
</html>
